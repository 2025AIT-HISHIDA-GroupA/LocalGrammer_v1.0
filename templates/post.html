{% extends "base.html" %}

{% block title %}æŠ•ç¨¿ - æŠ•ç¨¿ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<!-- Leafletã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<h2>æ–°ã—ã„æŠ•ç¨¿</h2>

<form method="POST" enctype="multipart/form-data" id="postForm">
    <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§åº§æ¨™ã‚’é€ä¿¡ -->
    <input type="hidden" id="latitude" name="latitude">
    <input type="hidden" id="longitude" name="longitude">

    <div class="form-group">
        <label>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (æœ€å¤§4æš):</label>
        <div style="margin-bottom: 10px;">
            <label for="image1" style="font-weight: bold; margin-right: 10px;">ç”»åƒ1</label>
            <input type="file" id="image1" name="image1" accept="image/*" onchange="handleImageUpload(this, 1)">
            <div id="image1_status" class="image-status"></div>
        </div>
        <div style="margin-bottom: 10px;">
            <label for="image2" style="font-weight: bold; margin-right: 10px;">ç”»åƒ2</label>
            <input type="file" id="image2" name="image2" accept="image/*" onchange="handleImageUpload(this, 2)">
            <div id="image2_status" class="image-status"></div>
        </div>
        <div style="margin-bottom: 10px;">
            <label for="image3" style="font-weight: bold; margin-right: 10px;">ç”»åƒ3</label>
            <input type="file" id="image3" name="image3" accept="image/*" onchange="handleImageUpload(this, 3)">
            <div id="image3_status" class="image-status"></div>
        </div>
        <div style="margin-bottom: 10px;">
            <label for="image4" style="font-weight: bold; margin-right: 10px;">ç”»åƒ4</label>
            <input type="file" id="image4" name="image4" accept="image/*" onchange="handleImageUpload(this, 4)">
            <div id="image4_status" class="image-status"></div>
        </div>
        <small style="color: #666;">å¯¾å¿œå½¢å¼: PNG, JPG, JPEG, GIF, WebP</small>

        <!-- ä½ç½®æƒ…å ±ã®å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div id="overallLocationStatus" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;">
            <div id="locationStatusText"></div>
            <div id="locationDetails" style="font-size: 0.85em; margin-top: 5px; color: #666;"></div>

            <!-- GPSä½ç½®æƒ…å ±é¸æŠãƒ‘ãƒãƒ« -->
            <div id="gpsSelectionPanel"
                style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.8); border-radius: 8px; border: 1px solid #ddd;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333;">ğŸ“ ä½¿ç”¨ã™ã‚‹ä½ç½®æƒ…å ±ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</div>
                <div id="gpsOptions" style="display: grid; gap: 8px;"></div>
                <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <strong>ç¾åœ¨é¸æŠä¸­:</strong> <span id="currentGPSSelection">ãªã—</span>
                </div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="tag">ã‚¿ã‚°:</label>
        <select id="tag" name="tag" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            {% for tag in tags %}
            <option value="{{ tag }}">{{ tag }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="region">åœ°åŸŸ:</label>
        <select id="region" name="region">
            <option value="">é¸æŠã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯ä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ï¼‰</option>
            {% for region in regions %}
            <option value="{{ region }}">{{ region }}</option>
            {% endfor %}
        </select>
        <small style="color: #666;">ç”»åƒã®ä½ç½®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ã§åœ°åŸŸãŒé¸æŠã•ã‚Œã‚‹ã‹ã€åœ°å›³ã‹ã‚‰åœ°ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</small>
    </div>

    <!-- åœ°å›³ã§åœ°ç‚¹é¸æŠ -->
    <div class="form-group">
        <label>åœ°å›³ã‹ã‚‰åœ°ç‚¹ã‚’é¸æŠ:</label>
        <div id="postMap" style="width: 100%; height: 400px; border-radius: 8px; margin-top: 10px;"></div>
        <small style="color: #666;">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã§ãã¾ã™ã€‚é¸æŠã—ãŸåœ°ç‚¹ã‹ã‚‰è‡ªå‹•ã§åœ°åŸŸãŒåˆ¤å®šã•ã‚Œã¾ã™ã€‚</small>
    </div>

    <div style="display: flex; gap: 15px; margin-top: 20px;">
        <button type="submit" class="btn" style="min-width: 120px;">æŠ•ç¨¿</button>
        <a href="{{ url_for('main.home') }}" class="btn btn-secondary"
            style="min-width: 120px; text-align: center;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
    </div>
</form>

<style>
    .image-status {
        margin-top: 5px;
        font-size: 0.85em;
        padding: 3px 8px;
        border-radius: 3px;
        display: none;
    }

    .image-status.loading {
        display: block;
        background-color: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .image-status.success {
        display: block;
        background-color: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .image-status.warning {
        display: block;
        background-color: #fff3e0;
        color: #f57c00;
        border: 1px solid #ffcc02;
    }

    .image-status.error {
        display: block;
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }

    #overallLocationStatus.success {
        background-color: #e8f5e8;
        border: 2px solid #4caf50;
        color: #2e7d32;
    }

    #overallLocationStatus.warning {
        background-color: #fff3e0;
        border: 2px solid #ff9800;
        color: #f57c00;
    }

    #overallLocationStatus.error {
        background-color: #ffebee;
        border: 2px solid #f44336;
        color: #c62828;
    }

    .gps-option {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .gps-option:hover {
        border-color: #2196f3;
        background: #f5f5f5;
    }

    .gps-option.selected {
        border-color: #4caf50;
        background: #e8f5e8;
        font-weight: bold;
    }

    .gps-option-info {
        flex: 1;
    }

    .gps-option-coords {
        font-size: 0.8em;
        color: #666;
        margin-top: 2px;
    }

    .gps-option-badge {
        background: #2196f3;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: bold;
    }

    .gps-option.selected .gps-option-badge {
        background: #4caf50;
    }

    /* ç”»åƒé¸æŠéƒ¨åˆ†ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ */
    .form-group>div {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    /* ãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
    .form-group label[for^="image"] {
        min-width: 60px;
        color: #333;
        font-size: 0.95em;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    input[type="file"] {
        flex: 1;
        max-width: 300px;
    }
</style>

<script>
    let postMap;
    let currentMarker = null;
    let uploadedImages = [];
    let availableGPSData = []; // åˆ©ç”¨å¯èƒ½ãªGPSæƒ…å ±ã‚’ä¿å­˜
    let selectedGPSIndex = 0; // é¸æŠã•ã‚ŒãŸGPSæƒ…å ±ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

    // åœ°å›³ã®åˆæœŸåŒ–
    function initPostMap() {
        // æ—¥æœ¬ã®ä¸­å¿ƒä»˜è¿‘ã‚’åˆæœŸè¡¨ç¤º
        postMap = L.map('postMap').setView([36.0, 138.0], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(postMap);

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        postMap.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // åº§æ¨™ã‚’è¨­å®š
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
            updateMapMarker(lat, lng);

            // åœ°åŸŸã‚’è‡ªå‹•åˆ¤å®šï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
            detectRegionFromCoordinates(lat, lng, false);

            // GPSé¸æŠãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºï¼ˆæ‰‹å‹•é¸æŠæ™‚ï¼‰
            document.getElementById('gpsSelectionPanel').style.display = 'none';
            updateOverallLocationStatus('success', 'åœ°å›³ã‹ã‚‰ä½ç½®ã‚’æ‰‹å‹•è¨­å®šã—ã¾ã—ãŸ',
                `ç·¯åº¦: ${lat.toFixed(6)}, çµŒåº¦: ${lng.toFixed(6)}`);
        });
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
    function updateMapMarker(lat, lng) {
        if (currentMarker) {
            postMap.removeLayer(currentMarker);
        }

        const redIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 41" fill="#e74c3c">
                <path d="M12.5 0C5.6 0 0 5.6 0 12.5c0 5.4 3.2 10.1 7.8 12.2L12.5 41l4.7-16.3c4.6-2.1 7.8-6.8 7.8-12.2C25 5.6 19.4 0 12.5 0z"/>
                <circle cx="12.5" cy="12.5" r="7" fill="white"/>
            </svg>
        `),
            iconSize: [25, 40],
            iconAnchor: [12, 40],
            popupAnchor: [0, -40]
        });

        currentMarker = L.marker([lat, lng], { icon: redIcon }).addTo(postMap);
        postMap.setView([lat, lng], 15);
    }

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    function handleImageUpload(input, imageNumber) {
        const file = input.files[0];
        if (!file) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ
            const statusElement = document.getElementById(`image${imageNumber}_status`);
            statusElement.className = 'image-status';
            statusElement.style.display = 'none';

            // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤
            const existingPreview = document.getElementById(input.id + '_preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            uploadedImages[imageNumber - 1] = null;

            // GPSæƒ…å ±ã‹ã‚‰ã‚‚å‰Šé™¤
            availableGPSData = availableGPSData.filter(gps => gps.imageNumber !== imageNumber);
            updateGPSSelectionPanel();

            return;
        }

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’è¨˜éŒ²
        uploadedImages[imageNumber - 1] = file;

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        setupImagePreview(input.id);

        // GPSæƒ…å ±ã‚’è‡ªå‹•æŠ½å‡º
        extractGPSFromSingleImage(file, imageNumber);
    }

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
    function setupImagePreview(inputId) {
        const input = document.getElementById(inputId);
        const file = input.files[0];
        if (file) {
            // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤
            const existingPreview = document.getElementById(inputId + '_preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // æ–°ã—ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.createElement('div');
                preview.id = inputId + '_preview';
                preview.innerHTML = `<img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover; margin-top: 5px; border-radius: 4px;">`;
                input.parentElement.appendChild(preview);
            };
            reader.readAsDataURL(file);
        }
    }

    // å˜ä¸€ç”»åƒã‹ã‚‰GPSæƒ…å ±ã‚’æŠ½å‡º
    function extractGPSFromSingleImage(file, imageNumber) {
        const statusElement = document.getElementById(`image${imageNumber}_status`);

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ç¤º
        statusElement.className = 'image-status loading';
        statusElement.textContent = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’ç¢ºèªä¸­...';

        const formData = new FormData();
        formData.append('image', file);

        fetch('/api/extract_gps_from_single_image', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.latitude && data.longitude) {
                    const lat = parseFloat(data.latitude);
                    const lng = parseFloat(data.longitude);

                    // GPSæƒ…å ±ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
                    statusElement.className = 'image-status success';
                    statusElement.textContent = 'âœ… GPSæƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';

                    // GPSæƒ…å ±ã‚’ä¿å­˜
                    const existingIndex = availableGPSData.findIndex(gps => gps.imageNumber === imageNumber);
                    if (existingIndex >= 0) {
                        availableGPSData[existingIndex] = { lat, lng, imageNumber, fileName: file.name };
                    } else {
                        availableGPSData.push({ lat, lng, imageNumber, fileName: file.name });
                    }

                    // GPSé¸æŠãƒ‘ãƒãƒ«ã‚’æ›´æ–°
                    updateGPSSelectionPanel();

                    // åˆå›ã®GPSæƒ…å ±ã®å ´åˆã¯è‡ªå‹•é©ç”¨
                    if (availableGPSData.length === 1 || !document.getElementById('latitude').value) {
                        selectedGPSIndex = availableGPSData.length - 1;
                        applySelectedGPS();
                    }

                } else {
                    // GPSæƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
                    statusElement.className = 'image-status warning';
                    statusElement.textContent = 'âš ï¸ GPSæƒ…å ±ãªã—';

                    // GPSæƒ…å ±ãŒãªã„å ´åˆã®å‡¦ç†
                    if (availableGPSData.length === 0) {
                        updateOverallLocationStatus('warning', 'ä½ç½®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                            'åœ°å›³ã‹ã‚‰æ‰‹å‹•ã§ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusElement.className = 'image-status error';
                statusElement.textContent = 'âŒ å‡¦ç†ã‚¨ãƒ©ãƒ¼';

                if (availableGPSData.length === 0) {
                    updateOverallLocationStatus('error', 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
                        'åœ°å›³ã‹ã‚‰æ‰‹å‹•ã§ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            });
    }

    // GPSé¸æŠãƒ‘ãƒãƒ«ã‚’æ›´æ–°
    function updateGPSSelectionPanel() {
        const panel = document.getElementById('gpsSelectionPanel');
        const optionsContainer = document.getElementById('gpsOptions');

        if (availableGPSData.length <= 1) {
            panel.style.display = 'none';
            return;
        }

        // è¤‡æ•°ã®GPSæƒ…å ±ãŒã‚ã‚‹å ´åˆã¯é¸æŠãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        panel.style.display = 'block';
        optionsContainer.innerHTML = '';

        availableGPSData.forEach((gpsData, index) => {
            const option = document.createElement('div');
            option.className = `gps-option ${index === selectedGPSIndex ? 'selected' : ''}`;
            option.onclick = () => selectGPS(index);

            option.innerHTML = `
                <div class="gps-option-info">
                    <div>ç”»åƒ${gpsData.imageNumber} - ${gpsData.fileName.substring(0, 20)}${gpsData.fileName.length > 20 ? '...' : ''}</div>
                    <div class="gps-option-coords">ç·¯åº¦: ${gpsData.lat.toFixed(6)}, çµŒåº¦: ${gpsData.lng.toFixed(6)}</div>
                </div>
                <div class="gps-option-badge">${index === selectedGPSIndex ? 'é¸æŠä¸­' : 'é¸æŠ'}</div>
            `;

            optionsContainer.appendChild(option);
        });

        updateCurrentSelection();
    }

    // GPSæƒ…å ±ã‚’é¸æŠ
    function selectGPS(index) {
        selectedGPSIndex = index;
        applySelectedGPS();
        updateGPSSelectionPanel();
    }

    // é¸æŠã•ã‚ŒãŸGPSæƒ…å ±ã‚’é©ç”¨
    function applySelectedGPS() {
        if (availableGPSData.length > 0 && selectedGPSIndex < availableGPSData.length) {
            const selectedGPS = availableGPSData[selectedGPSIndex];

            // åº§æ¨™ã‚’è¨­å®š
            document.getElementById('latitude').value = selectedGPS.lat;
            document.getElementById('longitude').value = selectedGPS.lng;

            // åœ°å›³ã‚’æ›´æ–°
            updateMapMarker(selectedGPS.lat, selectedGPS.lng);

            // åœ°åŸŸã‚’è‡ªå‹•åˆ¤å®š
            detectRegionFromCoordinates(selectedGPS.lat, selectedGPS.lng, true);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            if (availableGPSData.length === 1) {
                updateOverallLocationStatus('success', `ç”»åƒ${selectedGPS.imageNumber}ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ`,
                    `ç·¯åº¦: ${selectedGPS.lat.toFixed(6)}, çµŒåº¦: ${selectedGPS.lng.toFixed(6)}`);
            } else {
                updateOverallLocationStatus('success', `${availableGPSData.length}æšã®ç”»åƒã‹ã‚‰ä½ç½®æƒ…å ±ãŒåˆ©ç”¨å¯èƒ½`,
                    `ç¾åœ¨ä½¿ç”¨ä¸­: ç”»åƒ${selectedGPS.imageNumber}ã®ä½ç½®æƒ…å ±`);
            }

            updateCurrentSelection();
        }
    }

    // ç¾åœ¨ã®é¸æŠã‚’æ›´æ–°
    function updateCurrentSelection() {
        const currentSelection = document.getElementById('currentGPSSelection');
        if (availableGPSData.length > 0 && selectedGPSIndex < availableGPSData.length) {
            const selectedGPS = availableGPSData[selectedGPSIndex];
            currentSelection.textContent = `ç”»åƒ${selectedGPS.imageNumber} (${selectedGPS.lat.toFixed(4)}, ${selectedGPS.lng.toFixed(4)})`;
        } else {
            currentSelection.textContent = 'ãªã—';
        }
    }

    // å…¨ä½“ã®ä½ç½®æƒ…å ±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    function updateOverallLocationStatus(type, message, details) {
        const statusContainer = document.getElementById('overallLocationStatus');
        const statusText = document.getElementById('locationStatusText');
        const statusDetails = document.getElementById('locationDetails');

        statusContainer.className = type;
        statusContainer.style.display = 'block';
        statusText.textContent = message;
        statusDetails.textContent = details;
    }

    // åº§æ¨™ã‹ã‚‰åœ°åŸŸã‚’åˆ¤å®š
    function detectRegionFromCoordinates(latitude, longitude, updateStatus = false) {
        fetch('/api/detect_region', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const regionSelect = document.getElementById('region');
                    regionSelect.value = data.region;

                    console.log(`åœ°åŸŸãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã—ãŸ: ${data.region}`);
                }
            })
            .catch(error => {
                console.error('åœ°åŸŸåˆ¤å®šã‚¨ãƒ©ãƒ¼:', error);
            });
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
    document.getElementById('postForm').addEventListener('submit', function (e) {
        const tag = document.getElementById('tag').value;
        const region = document.getElementById('region').value;
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;

        if (!tag) {
            alert('ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            e.preventDefault();
            return;
        }

        if (!region && !latitude) {
            alert('åœ°åŸŸã‚’é¸æŠã™ã‚‹ã‹ã€ä½ç½®æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            e.preventDefault();
            return;
        }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åœ°å›³ã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function () {
        initPostMap();
    });
</script>
{% endblock %}