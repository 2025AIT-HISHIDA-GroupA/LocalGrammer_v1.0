{% extends "base.html" %}

{% block title %}æŠ•ç¨¿ - æŠ•ç¨¿ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<h2>æ–°ã—ã„æŠ•ç¨¿</h2>

<form method="POST" enctype="multipart/form-data" id="postForm">
    <div class="form-group">
        <label>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (æœ€å¤§4æš):</label>
        <div style="margin-bottom: 10px;">
            <input type="file" id="image1" name="image1" accept="image/*" onchange="checkImageCoordinates(this)">
            <label for="image1" style="font-weight: normal; margin-left: 5px;">ç”»åƒ1</label>
        </div>
        <div style="margin-bottom: 10px;">
            <input type="file" id="image2" name="image2" accept="image/*" onchange="checkImageCoordinates(this)">
            <label for="image2" style="font-weight: normal; margin-left: 5px;">ç”»åƒ2</label>
        </div>
        <div style="margin-bottom: 10px;">
            <input type="file" id="image3" name="image3" accept="image/*" onchange="checkImageCoordinates(this)">
            <label for="image3" style="font-weight: normal; margin-left: 5px;">ç”»åƒ3</label>
        </div>
        <div style="margin-bottom: 10px;">
            <input type="file" id="image4" name="image4" accept="image/*" onchange="checkImageCoordinates(this)">
            <label for="image4" style="font-weight: normal; margin-left: 5px;">ç”»åƒ4</label>
        </div>
        <small style="color: #666;">å¯¾å¿œå½¢å¼: PNG, JPG, JPEG, GIF, WebP</small>
        <div id="imageCoordinateInfo"
            style="margin-top: 10px; padding: 10px; background-color: #e7f3ff; border-radius: 4px; display: none;">
            <strong>ğŸ“ ç”»åƒã‹ã‚‰ä½ç½®æƒ…å ±ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼</strong>
            <div id="detectedCoordinates"></div>
        </div>
    </div>

    <div class="form-group">
        <label for="tag">ã‚¿ã‚°:</label>
        <select id="tag" name="tag" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            {% for tag in tags %}
            <option value="{{ tag }}">{{ tag }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="region">åœ°åŸŸ:</label>
        <select id="region" name="region" required onchange="updateMapCenter()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            {% for region in regions %}
            <option value="{{ region }}">{{ region }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- ä½ç½®æƒ…å ±è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="form-group">
        <label>ğŸ“ ä½ç½®æƒ…å ±è¨­å®š (å¿…é ˆ):</label>
        <div style="margin-bottom: 10px;">
            <p style="color: #666; font-size: 0.9em;">
                åœ°å›³ä¸Šã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦æŠ•ç¨¿å ´æ‰€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ç”»åƒã«ä½ç½®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•ã§æ¤œå‡ºã•ã‚Œã¾ã™ã€‚
            </p>
        </div>

        <!-- åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="map"
            style="height: 400px; width: 100%; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;"></div>

        <!-- åº§æ¨™è¡¨ç¤ºãƒ»æ‰‹å‹•å…¥åŠ› -->
        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
            <div>
                <label for="manual_lat" style="font-size: 0.9em;">ç·¯åº¦:</label>
                <input type="number" id="manual_lat" name="manual_lat" step="any" style="width: 120px;" readonly>
            </div>
            <div>
                <label for="manual_lng" style="font-size: 0.9em;">çµŒåº¦:</label>
                <input type="number" id="manual_lng" name="manual_lng" step="any" style="width: 120px;" readonly>
            </div>
            <button type="button" onclick="clearCoordinates()"
                style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>

        <div id="coordinateStatus" style="padding: 8px; border-radius: 4px; font-size: 0.9em;">
            <span style="color: #dc3545;">âš ï¸ ä½ç½®æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
        </div>
    </div>

    <div style="display: flex; gap: 15px; margin-top: 20px;">
        <button type="submit" class="btn" style="min-width: 120px;" id="submitBtn" disabled>æŠ•ç¨¿</button>
        <a href="{{ url_for('main.home') }}" class="btn btn-secondary"
            style="min-width: 120px; text-align: center;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
    </div>
</form>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let currentMarker;
    let hasCoordinates = false;

    // åœ°åŸŸã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™
    const regionCoordinates = {{ region_coordinates | tojson }};

    // åœ°å›³åˆæœŸåŒ–
    function initMap() {
        map = L.map('map').setView([35.1803, 136.9066], 10); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: åå¤å±‹

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        map.on('click', function (e) {
            setCoordinates(e.latlng.lat, e.latlng.lng, 'manual');
        });
    }

    // åº§æ¨™è¨­å®š
    function setCoordinates(lat, lng, source) {
        document.getElementById('manual_lat').value = lat.toFixed(6);
        document.getElementById('manual_lng').value = lng.toFixed(6);

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
        if (currentMarker) {
            map.removeLayer(currentMarker);
        }

        currentMarker = L.marker([lat, lng]).addTo(map);

        // æ‰‹å‹•è¨­å®šã®å ´åˆã¯ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´ã—ãªã„
        if (source === 'manual') {
            // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ä¿æŒã—ã¦ä¸­å¿ƒã®ã¿ç§»å‹•
            const currentZoom = map.getZoom();
            map.setView([lat, lng], currentZoom);
        } else {
            // ç”»åƒã‹ã‚‰è‡ªå‹•æ¤œå‡ºã®å ´åˆã¯è©³ç´°è¡¨ç¤ºã®ãŸã‚ã‚ºãƒ¼ãƒ ã‚¤ãƒ³
            map.setView([lat, lng], 15);
        }

        hasCoordinates = true;
        updateCoordinateStatus(source);
        updateSubmitButton();
    }

    // åº§æ¨™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateCoordinateStatus(source) {
        const statusDiv = document.getElementById('coordinateStatus');
        if (hasCoordinates) {
            const sourceText = source === 'manual' ? 'æ‰‹å‹•è¨­å®š' : 'ç”»åƒã‹ã‚‰è‡ªå‹•æ¤œå‡º';
            statusDiv.innerHTML = '<span style="color: #28a745;">âœ… ä½ç½®æƒ…å ±ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ (' + sourceText + ')</span>';
        } else {
            statusDiv.innerHTML = '<span style="color: #dc3545;">âš ï¸ ä½ç½®æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</span>';
        }
    }

    // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        if (hasCoordinates) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
        } else {
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
        }
    }

    // åº§æ¨™ã‚¯ãƒªã‚¢
    function clearCoordinates() {
        document.getElementById('manual_lat').value = '';
        document.getElementById('manual_lng').value = '';

        if (currentMarker) {
            map.removeLayer(currentMarker);
            currentMarker = null;
        }

        hasCoordinates = false;
        updateCoordinateStatus();
        updateSubmitButton();

        // ç”»åƒåº§æ¨™æƒ…å ±ã‚‚éè¡¨ç¤º
        document.getElementById('imageCoordinateInfo').style.display = 'none';
    }

    // åœ°åŸŸå¤‰æ›´æ™‚ã®åœ°å›³ä¸­å¿ƒæ›´æ–°
    function updateMapCenter() {
        const regionSelect = document.getElementById('region');
        const selectedRegion = regionSelect.value;

        if (selectedRegion && regionCoordinates[selectedRegion]) {
            const coords = regionCoordinates[selectedRegion];
            map.setView(coords, 10);
        }
    }

    // ç”»åƒã®ä½ç½®æƒ…å ±ãƒã‚§ãƒƒã‚¯ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å®Ÿè£…ï¼‰
    function checkImageCoordinates(input) {
        setupImagePreview(input.id);

        if (input.files && input.files[0]) {
            const file = input.files[0];
            const formData = new FormData();
            formData.append('image', file);

            // ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒã‚’é€ä¿¡ã—ã¦ä½ç½®æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
            fetch('/check_image_coordinates', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.has_coordinates) {
                        showImageCoordinateInfo(data.latitude, data.longitude);
                        setCoordinates(data.latitude, data.longitude, 'exif');

                        // åœ°åŸŸè‡ªå‹•é¸æŠ
                        if (data.region_info && data.region_info.suggested_region) {
                            autoSelectRegion(data.region_info);
                        }
                    } else if (data.success && !data.has_coordinates) {
                        // ä½ç½®æƒ…å ±ãªã—ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¡¨ç¤ºã—ãªã„ï¼‰
                        console.log('ç”»åƒã«ä½ç½®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    } else {
                        console.error('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.message);
                    }
                })
                .catch(error => {
                    console.error('ç”»åƒã®ä½ç½®æƒ…å ±ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                });
        }
    }

    // åœ°åŸŸè‡ªå‹•é¸æŠ
    function autoSelectRegion(regionInfo) {
        const regionSelect = document.getElementById('region');
        const suggestedRegion = regionInfo.suggested_region;
        const confidence = regionInfo.confidence;
        const autoDetected = regionInfo.auto_detected;

        console.log('åœ°åŸŸè‡ªå‹•é¸æŠ:', regionInfo);

        // åœ°åŸŸã‚’è‡ªå‹•é¸æŠ
        if (suggestedRegion) {
            regionSelect.value = suggestedRegion;

            // åœ°åŸŸå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ï¼ˆåœ°å›³ã®ä¸­å¿ƒã‚’æ›´æ–°ï¼‰
            updateMapCenter();

            // è‡ªå‹•é¸æŠã®é€šçŸ¥ã‚’è¡¨ç¤º
            showRegionAutoSelection(suggestedRegion, confidence, autoDetected);
        }
    }

    // åœ°åŸŸè‡ªå‹•é¸æŠã®é€šçŸ¥è¡¨ç¤º
    function showRegionAutoSelection(region, confidence, autoDetected) {
        // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
        const existingNotification = document.getElementById('regionAutoNotification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const detectionText = autoDetected ? 'ğŸ¯' : 'ğŸ”';
        const bgColor = confidence === 'high' ? '#d4edda' : '#fff3cd';
        const textColor = confidence === 'high' ? '#155724' : '#856404';

        const notification = document.createElement('div');
        notification.id = 'regionAutoNotification';
        notification.style.cssText = `
            margin-top: 10px; 
            padding: 10px; 
            background-color: ${bgColor}; 
            border-radius: 4px; 
            color: ${textColor};
            border: 1px solid ${confidence === 'high' ? '#c3e6cb' : '#ffeaa7'};
        `;
        notification.innerHTML = `
            <strong>${detectionText} åœ°åŸŸãŒè‡ªå‹•é¸æŠã•ã‚Œã¾ã—ãŸ</strong><br>
            æ¤œå‡ºåœ°åŸŸ: <strong>${region}</strong>
        `;

        // åœ°åŸŸé¸æŠæ¬„ã®ä¸‹ã«é€šçŸ¥ã‚’æŒ¿å…¥
        const regionFormGroup = document.getElementById('region').closest('.form-group');
        regionFormGroup.appendChild(notification);

        // 5ç§’å¾Œã«é€šçŸ¥ã‚’è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
            if (notification && notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // ç”»åƒåº§æ¨™æƒ…å ±è¡¨ç¤º
    function showImageCoordinateInfo(lat, lng) {
        const infoDiv = document.getElementById('imageCoordinateInfo');
        const coordDiv = document.getElementById('detectedCoordinates');

        coordDiv.innerHTML = 'ç·¯åº¦: ' + lat.toFixed(6) + ', çµŒåº¦: ' + lng.toFixed(6);
        infoDiv.style.display = 'block';
    }

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
    function setupImagePreview(inputId) {
        const input = document.getElementById(inputId);
        const file = input.files[0];

        if (file) {
            // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤
            const existingPreview = document.getElementById(inputId + '_preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // æ–°ã—ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.createElement('div');
                preview.id = inputId + '_preview';
                preview.innerHTML = '<img src="' + e.target.result + '" style="width: 100px; height: 100px; object-fit: cover; margin-top: 5px; border-radius: 4px;">';
                input.parentElement.appendChild(preview);
            };
            reader.readAsDataURL(file);
        }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒã‚§ãƒƒã‚¯
    document.getElementById('postForm').addEventListener('submit', function (e) {
        if (!hasCoordinates) {
            e.preventDefault();
            alert('ä½ç½®æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚åœ°å›³ä¸Šã§ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ä½ç½®æƒ…å ±ä»˜ãã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åœ°å›³åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function () {
        initMap();
        updateSubmitButton();
    });
</script>
{% endblock %}