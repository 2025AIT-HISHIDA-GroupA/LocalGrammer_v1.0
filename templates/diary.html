{% extends "base.html" %}

{% block title %}æ—¥è¨˜ - æŠ•ç¨¿ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<h2>ã‚ãªãŸã®æŠ•ç¨¿å±¥æ­´</h2>

{% if posts %}
{% for post in posts %}
<div class="post" id="post-{{ post.id }}">
    <div class="post-header">
        <strong>{{ post.username }}</strong>
        <div class="post-meta">
            <span>{{ post.tag }}</span> |
            <span>{{ post.region.region }}</span> |
            <span>{{ post.created_at[:10] }}</span>
            <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            <button onclick="deletePost('{{ post.id }}')"
                style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; margin-left: 10px;">
                å‰Šé™¤
            </button>
        </div>
    </div>

    {% if post.images %}
    <div class="post-images" style="margin-top: 10px;">
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            {% for image in post.images %}
            <img src="{{ url_for('static', filename='uploads/' ~ image) }}" alt="æŠ•ç¨¿ç”»åƒ"
                style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                onclick="openImageModal('{{ url_for('static', filename='uploads/' ~ image) }}')">
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ¡ãƒ³ãƒˆæ•° -->
    <div class="post-actions"
        style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; gap: 20px; align-items: center;">
        <span style="color: #666;">ğŸ‘ {{ post.like_count }} </span>
        <span style="color: #666;">ğŸ’¬ {{ post.comment_count }} ã‚³ãƒ¡ãƒ³ãƒˆ</span>
    </div>
</div>
{% endfor %}
{% else %}
<p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<a href="{{ url_for('post') }}" class="btn">æœ€åˆã®æŠ•ç¨¿ã‚’ã™ã‚‹</a>
{% endif %}

<!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);">
    <span
        style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;"
        onclick="closeImageModal()">&times;</span>
    <img id="modalImage" style="margin: auto; display: block; width: 80%; max-width: 700px; margin-top: 50px;">
</div>

<script>
    function openImageModal(imageSrc) {
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });

    // æŠ•ç¨¿å‰Šé™¤æ©Ÿèƒ½
    function deletePost(postId) {
        if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            return;
        }

        fetch('/delete_post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + encodeURIComponent(postId)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æŠ•ç¨¿è¦ç´ ã‚’ç”»é¢ã‹ã‚‰å‰Šé™¤
                    const postElement = document.getElementById('post-' + postId);
                    if (postElement) {
                        postElement.remove();
                    }
                    alert('æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

                    // æŠ•ç¨¿ãŒã™ã¹ã¦ãªããªã£ãŸå ´åˆã®å‡¦ç†
                    const remainingPosts = document.querySelectorAll('.post');
                    if (remainingPosts.length === 0) {
                        location.reload();
                    }
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }
</script>
{% endblock %}