{% extends "base.html" %}

{% block title %}æŠ•ç¨¿è©³ç´° - æŠ•ç¨¿ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<!-- Leafletã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('main.home') if is_logged_in else url_for('auth.login') }}"
        style="color: #007bff; text-decoration: none;">
        {{ 'â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹' if is_logged_in else 'â† ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹' }}
    </a>
</div>

<h2>æŠ•ç¨¿è©³ç´°</h2>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã®æ¡ˆå†… -->
{% if not is_logged_in %}
<div
    style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border: 1px solid #bee5eb; border-radius: 8px; color: #0c5460;">
    <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“ æŠ•ç¨¿ã‚’è¦‹ã¦ã„ã‚‹æ–¹ã¸</div>
    <div style="font-size: 0.9em;">
        ã“ã®æŠ•ç¨¿ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚„ã„ã„ã­ã‚’ã—ãŸã„å ´åˆã¯ã€<a href="{{ url_for('auth.login') }}" style="color: #007bff;">ãƒ­ã‚°ã‚¤ãƒ³</a>ã¾ãŸã¯<a
            href="{{ url_for('auth.register') }}" style="color: #007bff;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</a>ã‚’ã—ã¦ãã ã•ã„ã€‚
    </div>
</div>
{% endif %}

<div class="post">
    <!-- ä¸Šéƒ¨: æŠ•ç¨¿å†…å®¹ã¨åœ°å›³ã®2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <!-- å·¦å´: æŠ•ç¨¿å†…å®¹ -->
        <div style="flex: 1;">
            <div class="post-header">
                <strong>{{ post.username }}</strong>
                <div class="post-meta">
                    <span>{{ post.tag }}</span> |
                    <span>{{ post.region.region }}</span> |
                    <span>{{ post.created_at[:10] }}</span>
                </div>
            </div>

            {% if post.images %}
            <div class="post-images" style="margin-top: 10px;">
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    {% for image in post.images %}
                    <img src="{{ url_for('static', filename='uploads/' ~ image) }}" alt="æŠ•ç¨¿ç”»åƒ"
                        style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                        onclick="openImageModal('{{ url_for('static', filename='uploads/' ~ image) }}')">
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- åœ°å›³è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
            {% if post.latitude and post.longitude %}
            <a href="{{ url_for('main.show_map', region=post.region.region) }}?post_id={{ post.id }}"
                style="display: inline-block; margin-top: 10px; padding: 5px 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; font-size: 0.9em;">
                ğŸ“ åœ°å›³ã§è©³ç´°ã‚’è¦‹ã‚‹
            </a>
            {% else %}
            <a href="{{ url_for('main.show_map', region=post.region.region) }}"
                style="display: inline-block; margin-top: 10px; padding: 5px 10px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 0.9em;">
                ğŸ—ºï¸ åœ°åŸŸã®åœ°å›³ã‚’è¡¨ç¤º
            </a>
            {% endif %}
        </div>

        <!-- å³å´: åŸ‹ã‚è¾¼ã¿åœ°å›³ -->
        <div style="flex-shrink: 0;">
            <div class="embedded-map" id="embedded-map-{{ post.id }}"
                style="width: 300px; height: 250px; border-radius: 8px; overflow: hidden; border: 2px solid #ddd; cursor: pointer;"
                onclick="openDetailMap('{{ post.id }}', '{{ post.region.region }}')">
            </div>
        </div>
    </div>

    <!-- ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã€ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã€å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆå…¨å¹…ï¼‰ -->
    <div class="post-actions"
        style="padding: 15px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; display: flex; gap: 20px; align-items: center; background-color: #f8f9fa;">

        {% if is_logged_in %}
        <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: é€šå¸¸ã®ã„ã„ã­ãƒœã‚¿ãƒ³ -->
        <button onclick="toggleLike('{{ post.id }}')" class="like-btn" id="like-btn-{{ post.id }}"
            style="background: {{ 'red' if post.user_liked else '#f0f0f0' }}; color: {{ 'white' if post.user_liked else '#333' }}; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1em;">
            ğŸ‘ <span id="like-count-{{ post.id }}">{{ post.like_count }}</span>
        </button>
        {% else %}
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„: è¡¨ç¤ºã®ã¿ã®ã„ã„ã­ãƒœã‚¿ãƒ³ -->
        <button onclick="promptLogin()"
            style="background: #f0f0f0; color: #333; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1em;">
            ğŸ‘ {{ post.like_count }}
        </button>
        {% endif %}

        <button onclick="toggleComments('{{ post.id }}')"
            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 1em;">
            ğŸ’¬ {{ post.comment_count }} ã‚³ãƒ¡ãƒ³ãƒˆ
        </button>

        <!-- å…±æœ‰ãƒœã‚¿ãƒ³ -->
        <button onclick="sharePost('{{ post.id }}')"
            style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1em;">
            ğŸ”— å…±æœ‰
        </button>
    </div>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
    <div id="comments-{{ post.id }}"
        style="margin: 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 0 0 12px 12px;">
        <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
        <div id="existing-comments-{{ post.id }}" style="margin-bottom: 25px;">
            {% if post.comments %}
            <h3
                style="margin: 0 0 20px 0; color: #495057; font-size: 1.2em; border-bottom: 2px solid #007bff; padding-bottom: 8px; display: inline-block;">
                ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§
            </h3>
            <div style="display: grid; gap: 15px;" id="comments-container-{{ post.id }}">
                {% for comment in post.comments %}
                <div class="comment" id="comment-{{ comment.id }}"
                    style="background: white; padding: 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #007bff;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div
                            style="font-weight: 600; color: #007bff; font-size: 1em; display: flex; align-items: center; gap: 8px;">
                            <span
                                style="background: #007bff; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                                {{ comment.username[0].upper() }}
                            </span>
                            {{ comment.username }}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div
                                style="font-size: 0.85em; color: #6c757d; background: #f8f9fa; padding: 4px 12px; border-radius: 20px;">
                                ğŸ“… {{ comment.created_at[:10] }}
                            </div>
                            <!-- ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆè‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã€ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ã¿ï¼‰ -->
                            {% if is_logged_in and comment.username == session.username %}
                            <button onclick="deleteComment('{{ comment.id }}', '{{ post.id }}')"
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7em;"
                                title="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤">
                                ğŸ—‘ï¸
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div style="color: #495057; line-height: 1.6; font-size: 1em; margin-left: 40px;">
                        {{ comment.comment }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div
                style="text-align: center; padding: 30px; color: #6c757d; background: white; border-radius: 12px; border: 2px dashed #dee2e6;">
                <span style="font-size: 2em; margin-bottom: 10px; display: block;">ğŸ’­</span>
                <p style="margin: 0; font-size: 1.1em;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #adb5bd;">æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
            </div>
            {% endif %}
        </div>

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ã¿è¡¨ç¤ºï¼‰ -->
        {% if is_logged_in %}
        <form onsubmit="addComment(event, '{{ post.id }}')"
            style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4
                style="margin: 0 0 15px 0; color: #495057; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                âœï¸ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã
            </h4>
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <div style="flex: 1;">
                    <textarea id="comment-input-{{ post.id }}" placeholder="ã‚ãªãŸã®æ€ã„ã‚’æ›¸ã„ã¦ãã ã•ã„..."
                        style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; resize: vertical; min-height: 80px; font-size: 1em; line-height: 1.5; box-sizing: border-box; transition: border-color 0.3s; font-family: inherit;"
                        onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e9ecef'"></textarea>
                    <div style="margin-top: 8px; font-size: 0.85em; color: #6c757d;">
                        ğŸ’¡ é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                    </div>
                </div>
                <button type="submit"
                    style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; white-space: nowrap; box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);">
                    ğŸ“¤ é€ä¿¡
                </button>
            </div>
        </form>
        {% else %}
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã®ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¡ˆå†… -->
        <div
            style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 1.1em;">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯</h4>
            <p style="margin: 0 0 15px 0; color: #6c757d;">ã“ã®æŠ•ç¨¿ã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <a href="{{ url_for('auth.login') }}"
                    style="background: #007bff; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </a>
                <a href="{{ url_for('auth.register') }}"
                    style="background: #28a745; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                    æ–°è¦ç™»éŒ²
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);">
    <span
        style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;"
        onclick="closeImageModal()">&times;</span>
    <img id="modalImage" style="margin: auto; display: block; width: 80%; max-width: 700px;">
</div>

<script>
    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ JavaScript å¤‰æ•°ã¨ã—ã¦è¨­å®š
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};

    // åœ°å›³åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function () {
        initEmbeddedMap(
            '{{ post.id }}',
            {% if post.latitude %}'{{ post.latitude }}'{% else %}null{% endif %},
        {% if post.longitude %}'{{ post.longitude }}'{% else %} null{% endif %},
    '{{ post.region.region }}'
        );
    });

    // åŸ‹ã‚è¾¼ã¿åœ°å›³ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
    function initEmbeddedMap(postId, latitude, longitude, regionName) {
        const mapContainer = document.getElementById('embedded-map-' + postId);
        if (!mapContainer) return;

        if (!latitude || !longitude) {
            mapContainer.style.backgroundColor = '#f0f0f0';
            mapContainer.style.display = 'flex';
            mapContainer.style.alignItems = 'center';
            mapContainer.style.justifyContent = 'center';
            mapContainer.innerHTML = '<div style="color: #666; font-size: 1.1em; text-align: center;">ğŸ—ºï¸<br>' + regionName + '</div>';
            return;
        }

        const map = L.map('embedded-map-' + postId, {
            zoomControl: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            dragging: false,
            touchZoom: false,
            attributionControl: false
        }).setView([parseFloat(latitude), parseFloat(longitude)], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        const redIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 41" fill="#e74c3c">
                <path d="M12.5 0C5.6 0 0 5.6 0 12.5c0 5.4 3.2 10.1 7.8 12.2L12.5 41l4.7-16.3c4.6-2.1 7.8-6.8 7.8-12.2C25 5.6 19.4 0 12.5 0z"/>
                <circle cx="12.5" cy="12.5" r="7" fill="white"/>
            </svg>
        `),
            iconSize: [25, 40],
            iconAnchor: [12, 40],
            popupAnchor: [0, -40]
        });

        L.marker([parseFloat(latitude), parseFloat(longitude)], { icon: redIcon })
            .addTo(map);
    }

    function openDetailMap(postId, regionName) {
        window.open('/map/' + encodeURIComponent(regionName) + '?post_id=' + encodeURIComponent(postId), '_blank');
    }

    function openImageModal(imageSrc) {
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });

    function toggleComments(postId) {
        // è©³ç´°ãƒšãƒ¼ã‚¸ã§ã¯å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä½•ã‚‚ã—ãªã„
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªæ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã®æ¡ˆå†…
    function promptLogin() {
        if (confirm('ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
            window.location.href = '{{ url_for("auth.login") }}';
        }
    }

    function toggleLike(postId) {
        if (!isLoggedIn) {
            promptLogin();
            return;
        }

        fetch('/toggle_like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + encodeURIComponent(postId)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likeBtn = document.getElementById('like-btn-' + postId);
                    const likeCount = document.getElementById('like-count-' + postId);

                    likeCount.textContent = data.like_count;

                    if (data.liked) {
                        likeBtn.style.background = 'red';
                        likeBtn.style.color = 'white';
                    } else {
                        likeBtn.style.background = '#f0f0f0';
                        likeBtn.style.color = '#333';
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }

    // å…±æœ‰æ©Ÿèƒ½
    function sharePost(postId) {
        const url = window.location.origin + '/post/' + postId;
        navigator.clipboard.writeText(url).then(function () {
            alert('æŠ•ç¨¿ã®URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }).catch(function () {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('æŠ•ç¨¿ã®URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        });
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
    function deleteComment(commentId, postId) {
        if (!isLoggedIn) {
            promptLogin();
            return;
        }

        if (!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }

        fetch('/delete_comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'comment_id=' + encodeURIComponent(commentId) + '&post_id=' + encodeURIComponent(postId)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´ ã‚’å‰Šé™¤
                    const commentElement = document.getElementById('comment-' + commentId);
                    if (commentElement) {
                        commentElement.remove();
                    }

                    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ›´æ–°
                    const commentButton = document.querySelector(`button[onclick="toggleComments('${postId}')"]`);
                    if (commentButton) {
                        const currentCount = parseInt(commentButton.textContent.match(/\d+/)[0]);
                        commentButton.innerHTML = `ğŸ’¬ ${Math.max(0, currentCount - 1)} ã‚³ãƒ¡ãƒ³ãƒˆ`;
                    }

                    // ã‚³ãƒ¡ãƒ³ãƒˆãŒã™ã¹ã¦ãªããªã£ãŸå ´åˆã®å‡¦ç†
                    const commentsContainer = document.getElementById('comments-container-' + postId);
                    if (commentsContainer && commentsContainer.children.length === 0) {
                        const existingComments = document.getElementById('existing-comments-' + postId);
                        existingComments.innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #6c757d; background: white; border-radius: 12px; border: 2px dashed #dee2e6;">
                                <span style="font-size: 2em; margin-bottom: 10px; display: block;">ğŸ’­</span>
                                <p style="margin: 0; font-size: 1.1em;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #adb5bd;">æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                            </div>
                        `;
                    }

                    alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }

    function addComment(event, postId) {
        event.preventDefault();

        if (!isLoggedIn) {
            promptLogin();
            return;
        }

        const commentInput = document.getElementById('comment-input-' + postId);
        const commentText = commentInput.value.trim();

        if (!commentText) {
            alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        fetch('/add_comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + encodeURIComponent(postId) + '&comment_text=' + encodeURIComponent(commentText)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const existingComments = document.getElementById('existing-comments-' + postId);

                    // "ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“"ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                    const noCommentsDiv = existingComments.querySelector('div[style*="text-align: center"]');
                    if (noCommentsDiv) {
                        noCommentsDiv.remove();

                        // ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 
                        existingComments.innerHTML = `
                            <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 1.2em; border-bottom: 2px solid #007bff; padding-bottom: 8px; display: inline-block;">
                                ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§
                            </h3>
                            <div style="display: grid; gap: 15px;" id="comments-container-${postId}">
                            </div>
                        `;
                    }

                    // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                    const commentsContainer = document.getElementById(`comments-container-${postId}`) ||
                        existingComments.querySelector('div[style*="display: grid"]');

                    const newComment = document.createElement('div');
                    newComment.className = 'comment';
                    newComment.id = 'comment-' + data.comment.id;
                    newComment.style.cssText = 'background: white; padding: 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #007bff; transition: transform 0.2s;';
                    newComment.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: 600; color: #007bff; font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                <span style="background: #007bff; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                                    ${data.comment.username[0].toUpperCase()}
                                </span>
                                ${data.comment.username}
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 0.85em; color: #6c757d; background: #f8f9fa; padding: 4px 12px; border-radius: 20px;">
                                    ğŸ“… ${data.comment.created_at.substring(0, 10)}
                                </div>
                                <button onclick="deleteComment('${data.comment.id}', '${postId}')"
                                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7em;"
                                    title="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                        <div style="color: #495057; line-height: 1.6; font-size: 1em; margin-left: 40px;">
                            ${data.comment.comment}
                        </div>
                    `;

                    if (commentsContainer) {
                        commentsContainer.appendChild(newComment);
                    } else {
                        existingComments.appendChild(newComment);
                    }

                    commentInput.value = '';

                    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ›´æ–°
                    const commentButton = document.querySelector(`button[onclick="toggleComments('${postId}')"]`);
                    if (commentButton) {
                        const currentCount = parseInt(commentButton.textContent.match(/\d+/)[0]);
                        commentButton.innerHTML = `ğŸ’¬ ${currentCount + 1} ã‚³ãƒ¡ãƒ³ãƒˆ`;
                    }

                    // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    newComment.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        newComment.style.transform = 'scale(1)';
                    }, 300);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }
</script>
{% endblock %}