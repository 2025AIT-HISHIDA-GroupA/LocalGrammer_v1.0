<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>{{ region }}ã®æŠ•ç¨¿ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
  </style>
</head>

<body>
  <h1>{{ region }}ã®æŠ•ç¨¿ãƒãƒƒãƒ—</h1>
  <div id="map"></div>
  <a href="{{ url_for('main.home') }}">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // åœ°åŸŸã”ã¨ã®ä¸­å¿ƒåº§æ¨™
    const regionCenters = {
      'æ±æµ·åœ': [35.1803, 136.9066], // æ„›çŸ¥çœŒåºï¼ˆåå¤å±‹ï¼‰
      'é¦–éƒ½åœ': [35.6895, 139.6917],  // æ±äº¬é§…
      'é–¢è¥¿åœ': [34.6937, 135.5023],  // å¤§é˜ªé§…
      'ä¹å·': [33.5902, 130.4017],    // ç¦å²¡å¸‚
      'æ²–ç¸„': [26.2123, 127.6792],    // é‚£è¦‡å¸‚
      'åŒ—æµ·é“': [43.0642, 141.3469],  // æœ­å¹Œå¸‚
      'æ±åŒ—': [38.2682, 140.8694],    // ä»™å°å¸‚
      'ä¸­å›½ãƒ»å››å›½': [34.3963, 132.4596], // åºƒå³¶å¸‚
      'åŒ—é™¸ãƒ»ç”²ä¿¡è¶Š': [36.6513, 138.1812] // é•·é‡å¸‚
    };

    // Jinjaã‹ã‚‰æ¸¡ã•ã‚ŒãŸåœ°åŸŸå
    const regionName = "{{ region }}";
    const center = regionCenters[regionName] || [35.6895, 139.6917]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ±äº¬

    const map = L.map('map').setView(center, 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const posts = {{ posts | tojson | default ('[]') }};

    posts.forEach(post => {
      const lat = parseFloat(post.latitude);
      const lon = parseFloat(post.longitude);

      if (!isNaN(lat) && !isNaN(lon)) {
        let imgHtml = '';
        if (post.images && post.images.length > 0) {
          imgHtml = `<img src="/static/uploads/${post.images[0]}" width="100" style="border-radius: 4px;">`;
        }

        const sourceIcon = post.coordinate_source === 'manual' ? 'ğŸ“' : 'ğŸ“·';
        const sourceText = post.coordinate_source === 'manual' ? 'æ‰‹å‹•è¨­å®š' : 'ç”»åƒã‹ã‚‰å–å¾—';

        const popupContent = `
        <div style="min-width: 200px;">
          <strong>${post.username}</strong><br>
          <span style="color: #666;">ã‚¿ã‚°: ${post.tag}</span><br>
          <span style="color: #666; font-size: 0.8em;">${sourceIcon} ${sourceText}</span><br>
          <div style="margin-top: 8px;">${imgHtml}</div>
        </div>
        `;

        // åº§æ¨™ã‚½ãƒ¼ã‚¹ã«å¿œã˜ã¦ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã‚’å¤‰æ›´
        let markerColor = post.coordinate_source === 'manual' ? 'red' : 'blue';

        const marker = L.marker([lat, lon]);
        marker.addTo(map).bindPopup(popupContent);
      }
    });
  </script>
</body>

</html>