<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>{{ region }}ã®æŠ•ç¨¿ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 600px;
      width: 100%;
    }

    .back-link {
      display: inline-block;
      margin: 10px 0;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }

    .back-link:hover {
      background-color: #0056b3;
    }
  </style>
</head>

<body>
  <h1>{{ region }}ã®æŠ•ç¨¿ãƒãƒƒãƒ—</h1>
  <div id="map"></div>
  <a href="{{ url_for('main.home') }}" class="back-link">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // åœ°åŸŸã”ã¨ã®ä¸­å¿ƒåº§æ¨™
    const regionCenters = {
      'æ±æµ·åœ': [35.1803, 136.9066], // æ„›çŸ¥çœŒåºï¼ˆåå¤å±‹ï¼‰
      'é¦–éƒ½åœ': [35.6895, 139.6917],  // æ±äº¬é§…
      'é–¢è¥¿åœ': [34.6937, 135.5023],  // å¤§é˜ªé§…
      'ä¹å·': [33.5902, 130.4017],    // ç¦å²¡å¸‚
      'æ²–ç¸„': [26.2123, 127.6792],    // é‚£è¦‡å¸‚
      'åŒ—æµ·é“': [43.0642, 141.3469],  // æœ­å¹Œå¸‚
      'æ±åŒ—': [38.2682, 140.8694],    // ä»™å°å¸‚
      'ä¸­å›½ãƒ»å››å›½': [34.3963, 132.4596], // åºƒå³¶å¸‚
      'åŒ—é™¸ãƒ»ç”²ä¿¡è¶Š': [36.6513, 138.1812] // é•·é‡å¸‚
    };

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šã®æŠ•ç¨¿IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const highlightPostId = urlParams.get('post_id');

    // Jinjaã‹ã‚‰æ¸¡ã•ã‚ŒãŸåœ°åŸŸåã¨æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿
    const regionName = "{{ region }}";
    const postList = {{ posts | tojson | default ('[]') }};

    // æŠ•ç¨¿ã«åº§æ¨™ãŒã‚ã‚‹å ´åˆã¯ã€ãã®ç¯„å›²ã«åˆã‚ã›ã¦åœ°å›³ã®ä¸­å¿ƒã‚’è¨­å®š
    let center = regionCenters[regionName] || [35.6895, 139.6917]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ±äº¬
    let zoom = 10;

    // ç‰¹å®šã®æŠ•ç¨¿ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã®å ´åˆã€ãã®åº§æ¨™ã‚’ä¸­å¿ƒã«ã™ã‚‹
    if (highlightPostId) {
      const targetPost = postList.find(post => post.id === highlightPostId);
      if (targetPost && targetPost.latitude && targetPost.longitude) {
        center = [targetPost.latitude, targetPost.longitude];
        zoom = 15; // ã‚ˆã‚Šè©³ç´°ãªã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
      }
    } else if (postList.length > 0) {
      // æŠ•ç¨¿ãŒã‚ã‚‹å ´åˆã¯ã€æŠ•ç¨¿ã®åº§æ¨™ã®ä¸­å¿ƒã‚’è¨ˆç®—
      const postsWithCoords = postList.filter(post => post.latitude && post.longitude);
      if (postsWithCoords.length > 0) {
        const avgLat = postsWithCoords.reduce((sum, post) => sum + parseFloat(post.latitude), 0) / postsWithCoords.length;
        const avgLon = postsWithCoords.reduce((sum, post) => sum + parseFloat(post.longitude), 0) / postsWithCoords.length;
        center = [avgLat, avgLon];
      }
    }

    const map = L.map('map').setView(center, zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾©
    const normalIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const highlightIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 41" fill="red">
          <path d="M12.5 0C5.6 0 0 5.6 0 12.5c0 5.4 3.2 10.1 7.8 12.2L12.5 41l4.7-16.3c4.6-2.1 7.8-6.8 7.8-12.2C25 5.6 19.4 0 12.5 0z"/>
          <circle cx="12.5" cy="12.5" r="7" fill="white"/>
        </svg>
      `),
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    postList.forEach(post => {
      if (post.latitude && post.longitude) {
        const lat = parseFloat(post.latitude);
        const lon = parseFloat(post.longitude);

        let imgHtml = '';
        if (post.images && post.images.length > 0) {
          imgHtml = `<img src="/static/uploads/${post.images[0]}" width="100" style="border-radius: 4px;">`;
        }

        const popupContent = `
          <div style="min-width: 120px;">
            <strong>${post.username}</strong><br>
            ã‚¿ã‚°: ${post.tag}<br>
            æ—¥æ™‚: ${post.created_at.substring(0, 10)}<br>
            ${imgHtml}
            ${highlightPostId === post.id ? '<br><strong style="color: red;">ğŸ“ é¸æŠã•ã‚ŒãŸæŠ•ç¨¿</strong>' : ''}
          </div>
        `;

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã‹ã©ã†ã‹ã§ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
        const icon = (highlightPostId === post.id) ? highlightIcon : normalIcon;

        const marker = L.marker([lat, lon], { icon: icon })
          .addTo(map)
          .bindPopup(popupContent);

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã®å ´åˆã¯è‡ªå‹•ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
        if (highlightPostId === post.id) {
          marker.openPopup();
        }
      }
    });

    // åº§æ¨™ä»˜ãã®æŠ•ç¨¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const postsWithCoords = postList.filter(post => post.latitude && post.longitude);
    console.log(`åœ°åŸŸ: ${regionName}, å…¨æŠ•ç¨¿æ•°: ${postList.length}, åº§æ¨™ä»˜ãæŠ•ç¨¿æ•°: ${postsWithCoords.length}`);

    if (postsWithCoords.length === 0) {
      const messageControl = L.control({ position: 'topright' });
      messageControl.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info');
        div.innerHTML = `
            <div style="background: white; padding: 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                <strong>ã“ã®åœ°åŸŸã®æŠ•ç¨¿æƒ…å ±</strong><br>
                å…¨æŠ•ç¨¿æ•°: ${postList.length}<br>
                ä½ç½®æƒ…å ±ä»˜ã: ${postsWithCoords.length}<br>
                ${postList.length > 0 ? 'ä½ç½®æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„æŠ•ç¨¿ãŒã‚ã‚Šã¾ã™' : 'ã“ã®åœ°åŸŸã«ã¯æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“'}
            </div>
        `;
        return div;
      };
      messageControl.addTo(map);
    }
  </script>
</body>

</html>