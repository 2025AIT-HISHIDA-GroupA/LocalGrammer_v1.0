{% extends "base.html" %}

{% block title %}ãƒ›ãƒ¼ãƒ  - æŠ•ç¨¿ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<h2>ãƒ›ãƒ¼ãƒ </h2>

{% if posts %}
{% for post in posts %}
<div class="post">
    <div class="post-header">
        <strong>{{ post.username }}</strong>
        <div class="post-meta">
            <span>{{ post.tag }}</span> |
            <span>{{ post.region.region }}</span> |
            <span>{{ post.created_at[:10] }}</span>
        </div>
    </div>

    {% if post.images %}
    <div style="display: flex; gap: 15px; margin-top: 10px; align-items: flex-start;">
        <!-- ç”»åƒã‚¨ãƒªã‚¢ -->
        <div class="post-images" style="flex: 1;">
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                {% for image in post.images %}
                <img src="{{ url_for('static', filename='uploads/' ~ image) }}" alt="æŠ•ç¨¿ç”»åƒ"
                    style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                    onclick="openImageModal('{{ url_for('static', filename='uploads/' ~ image) }}')">
                {% endfor %}
            </div>
        </div>

        <!-- åœ°å›³ã‚¨ãƒªã‚¢ -->
        {% if post.latitude and post.longitude %}
        <div class="post-map-container" style="flex: 0 0 300px;">
            <div class="post-map" id="post-map-{{ post.id }}"
                style="height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 8px;"
                data-lat="{{ post.latitude }}" data-lng="{{ post.longitude }}" data-username="{{ post.username }}"
                data-tag="{{ post.tag }}">
            </div>
            <div style="margin-top: 5px; font-size: 0.8em; color: #666; text-align: center;">
                ğŸ“ {{ post.region.region }}
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- ç”»åƒãŒãªã„å ´åˆã¯åœ°å›³ã®ã¿è¡¨ç¤º -->
    {% if post.latitude and post.longitude %}
    <div class="post-map-container" style="margin-top: 10px; max-width: 300px;">
        <div class="post-map" id="post-map-{{ post.id }}"
            style="height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 8px;"
            data-lat="{{ post.latitude }}" data-lng="{{ post.longitude }}" data-username="{{ post.username }}"
            data-tag="{{ post.tag }}">
        </div>
        <div style="margin-top: 5px; font-size: 0.8em; color: #666; text-align: center;">
            ğŸ“ {{ post.region.region }}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- ã‚°ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ¡ãƒ³ãƒˆæ•° -->
    <div class="post-actions"
        style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; gap: 20px; align-items: center;">
        <button onclick="toggleLike('{{ post.id }}')" class="like-btn" id="like-btn-{{ post.id }}"
            style="background: {{ 'red' if post.user_liked else '#f0f0f0' }}; color: {{ 'white' if post.user_liked else '#333' }}; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            ğŸ‘ <span id="like-count-{{ post.id }}">{{ post.like_count }}</span>
        </button>

        <button onclick="toggleComments('{{ post.id }}')"
            style="background: #f0f0f0; color: #333; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;">
            ğŸ’¬ {{ post.comment_count }} ã‚³ãƒ¡ãƒ³ãƒˆ
        </button>
    </div>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="comments-{{ post.id }}"
        style="display: none; margin-top: 15px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
        <!-- æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º -->
        <div id="existing-comments-{{ post.id }}">
            {% if post.comments %}
            {% for comment in post.comments %}
            <div class="comment"
                style="margin-bottom: 10px; padding: 10px; background-color: #ffffff; border-radius: 5px; border-left: 3px solid #007bff;">
                <div style="font-weight: bold; color: #007bff; font-size: 0.9em;">{{ comment.username }}</div>
                <div style="margin-top: 5px;">{{ comment.comment }}</div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">{{ comment.created_at[:10] }}</div>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form onsubmit="addComment(event, '{{ post.id }}')" style="margin-top: 15px;">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <textarea id="comment-input-{{ post.id }}" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; min-height: 60px; box-sizing: border-box;"></textarea>
                </div>
                <button type="submit"
                    style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                    é€ä¿¡
                </button>
            </div>
        </form>
    </div>

    <!-- åœ°å›³è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
    <a href="{{ url_for('main.show_map', region=post.region.region) }}"
        style="display: inline-block; margin-top: 10px; padding: 5px 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px;">
        åœ°å›³ã‚’è¡¨ç¤º
    </a>
</div>
{% endfor %}
{% else %}
<p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);">
    <span
        style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;"
        onclick="closeImageModal()">&times;</span>
    <img id="modalImage" style="margin: auto; display: block; width: 80%; max-width: 700px; margin-top: 50px;">
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // æŠ•ç¨¿åŸ‹ã‚è¾¼ã¿åœ°å›³ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function () {
        // å„æŠ•ç¨¿ã®åœ°å›³ã‚’åˆæœŸåŒ–
        const postMaps = document.querySelectorAll('.post-map');
        postMaps.forEach(function (mapElement) {
            const lat = parseFloat(mapElement.dataset.lat);
            const lng = parseFloat(mapElement.dataset.lng);
            const username = mapElement.dataset.username;
            const tag = mapElement.dataset.tag;
            const mapId = mapElement.id;

            if (!isNaN(lat) && !isNaN(lng)) {
                // å°ã•ãªåœ°å›³ã‚’ä½œæˆ
                const map = L.map(mapId, {
                    zoomControl: false,     // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
                    dragging: false,        // ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹
                    touchZoom: false,       // ã‚¿ãƒƒãƒã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹
                    doubleClickZoom: false, // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹
                    scrollWheelZoom: false, // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹
                    boxZoom: false,         // ãƒœãƒƒã‚¯ã‚¹ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹
                    keyboard: false,        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚’ç„¡åŠ¹
                    tap: false              // ã‚¿ãƒƒãƒ—ã‚’ç„¡åŠ¹
                }).setView([lat, lng], 15);

                // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                // ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã‚¢ã‚¤ã‚³ãƒ³
                const customIcon = L.divIcon({
                    className: 'custom-pin',
                    html: '<div style="background-color: #ff4757; width: 20px; height: 20px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                });

                // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                L.marker([lat, lng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup('<strong>' + username + '</strong><br>ã‚¿ã‚°: ' + tag);

                // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°åœ°å›³ã«é·ç§»
                map.on('click', function () {
                    const region = mapElement.closest('.post').querySelector('.post-meta span:nth-child(2)').textContent;
                    window.location.href = '/map/' + region;
                });

                // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼åŠ¹æœ
                mapElement.style.cursor = 'pointer';
                mapElement.addEventListener('mouseenter', function () {
                    mapElement.style.opacity = '0.8';
                });
                mapElement.addEventListener('mouseleave', function () {
                    mapElement.style.opacity = '1';
                });
            }
        });
    });

    function openImageModal(imageSrc) {
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });

    function toggleComments(postId) {
        const commentsSection = document.getElementById('comments-' + postId);
        if (commentsSection.style.display === 'none') {
            commentsSection.style.display = 'block';
        } else {
            commentsSection.style.display = 'none';
        }
    }

    function toggleLike(postId) {
        fetch('/toggle_like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + encodeURIComponent(postId)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likeBtn = document.getElementById('like-btn-' + postId);
                    const likeCount = document.getElementById('like-count-' + postId);

                    likeCount.textContent = data.like_count;

                    if (data.liked) {
                        likeBtn.style.background = 'red';
                        likeBtn.style.color = 'white';
                    } else {
                        likeBtn.style.background = '#f0f0f0';
                        likeBtn.style.color = '#333';
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }

    function addComment(event, postId) {
        event.preventDefault();

        const commentInput = document.getElementById('comment-input-' + postId);
        const commentText = commentInput.value.trim();

        if (!commentText) {
            alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        fetch('/add_comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + encodeURIComponent(postId) + '&comment_text=' + encodeURIComponent(commentText)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¿½åŠ 
                    const existingComments = document.getElementById('existing-comments-' + postId);
                    const newComment = document.createElement('div');
                    newComment.className = 'comment';
                    newComment.style.cssText = 'margin-bottom: 10px; padding: 10px; background-color: #ffffff; border-radius: 5px; border-left: 3px solid #007bff;';
                    newComment.innerHTML = `
                        <div style="font-weight: bold; color: #007bff; font-size: 0.9em;">${data.comment.username}</div>
                        <div style="margin-top: 5px;">${data.comment.comment}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${data.comment.created_at.substring(0, 10)}</div>
                    `;
                    existingComments.appendChild(newComment);

                    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    commentInput.value = '';

                    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«ï¼‰
                    const commentButton = document.querySelector(`button[onclick="toggleComments('${postId}')"]`);
                    if (commentButton) {
                        const currentCount = parseInt(commentButton.textContent.match(/\d+/)[0]);
                        commentButton.innerHTML = `ğŸ’¬ ${currentCount + 1} ã‚³ãƒ¡ãƒ³ãƒˆ`;
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }
</script>
{% endblock %}